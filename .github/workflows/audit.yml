name: Course Audit

on:
  schedule:
    # Run weekly on Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

env:
  MDBOOK_VERSION: v0.4.36

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install mdBook
        run: |
          curl -L https://github.com/rust-lang/mdBook/releases/download/${{ env.MDBOOK_VERSION }}/mdbook-${{ env.MDBOOK_VERSION }}-x86_64-unknown-linux-gnu.tar.gz | tar xz
          chmod +x mdbook
          
      - name: Verify book structure
        run: |
          echo "Checking book.toml configuration..."
          cat book/book.toml
          
          echo "Checking source files..."
          ls -la book/src/
          
      - name: Build book (dry run)
        run: cd book && ../mdbook build
        
      - name: Check for broken links
        run: |
          echo "Checking for broken internal links..."
          # Simple check for markdown files
          find book/src -name "*.md" -type f | wc -l
          
      - name: Verify critical files
        run: |
          echo "Verifying critical course files exist..."
          test -f book/src/SUMMARY.md || exit 1
          test -f book/book.toml || exit 1
          test -f README.md || exit 1
          echo "All critical files present"
          
      - name: Count course content
        run: |
          echo "Course Statistics:"
          echo "=================="
          echo "Markdown files: $(find book/src -name "*.md" | wc -l)"
          echo "Total lines: $(find book/src -name "*.md" -exec wc -l {} + | tail -1)"
          echo "Generated HTML files: $(find book/docs -name "*.html" 2>/dev/null | wc -l || echo 'Build needed')"
          
      - name: Check GitHub Pages deployment
        run: |
          echo "Checking GitHub Pages URL..."
          curl -I https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/ || echo "Pages may not be deployed yet"
          
      - name: Audit summary
        run: |
          echo "âœ… Course audit completed successfully"
          echo "ðŸ“š Course is properly structured and buildable"
          echo "ðŸš€ Ready for deployment"

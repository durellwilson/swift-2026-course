name: Auto-Generate Stubs

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 0'  # Weekly on Sunday at 2am

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Find missing files
        id: missing
        run: |
          MISSING=""
          grep -oP '\(\.\/[^)]+\.md\)' book/src/SUMMARY.md | sed 's/[()]//g' | sed 's/^\.\///' | while read -r file; do
            if [ ! -f "book/src/$file" ]; then
              echo "$file" >> missing_files.txt
            fi
          done
          
          if [ -f missing_files.txt ]; then
            echo "has_missing=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Generate stub files
        if: steps.missing.outputs.has_missing == 'true'
        run: |
          chmod +x .github/scripts/generate-stub.sh
          while read -r file; do
            mkdir -p "book/src/$(dirname "$file")"
            .github/scripts/generate-stub.sh "$file"
          done < missing_files.txt
          
      - name: Create Pull Request
        if: steps.missing.outputs.has_missing == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: generate stubs for missing content"
          title: "ðŸ¤– Auto-generated content stubs"
          body: |
            This PR adds stub files for missing course content.
            
            Generated files need to be filled with actual content.
            
            **Action Required:**
            - [ ] Review generated stubs
            - [ ] Add actual content
            - [ ] Test build
            
            *Auto-generated by content generation workflow*
          branch: auto-generate-stubs
          labels: auto-generated, documentation

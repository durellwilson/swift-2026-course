name: Content Audit

on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run content audit
        id: audit
        run: |
          chmod +x .github/scripts/audit-content.sh
          .github/scripts/audit-content.sh || echo "audit_failed=true" >> $GITHUB_OUTPUT
          
      - name: Create/Update tracking issue
        if: steps.audit.outputs.audit_failed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const content = fs.readFileSync('.github/MISSING_CONTENT.md', 'utf8');
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'content-audit'
            });
            
            const body = `${content}\n\n---\n*Auto-generated by content audit workflow*`;
            
            if (issues.data.length > 0) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: body
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ“‹ Missing Course Content',
                body: body,
                labels: ['content-audit', 'documentation']
              });
            }
            
      - name: Commit audit results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/MISSING_CONTENT.md || true
          git commit -m "chore: update content audit [skip ci]" || true
          git push || true
